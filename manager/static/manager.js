$(function(){function o(){$("#nav_list ul").sortable({connectWith:".menu-list",placeholder:"ui-state-highlight",forcePlaceholderSize:true,update:function(e,t){var n=$(t.item);if(this===t.item.parent()[0]){var r={};$("#nav_list").children(".menu").each(function(){var e=$(this).children(".menu_title").html();var t=$(this).children(".menu-list");var n=[];t.children().each(function(e){n[e]=$(this).find(".edit_pk").val()});r[e]=n});$("#notificator").notification({text:"The changes will be saved after confirmation",onOk:function(){$.post("/manager/nav/update/",{menu:$.toJSON(r)},function(e){if(e["error"]){$("#notificator").notification({text:e["error"],type:"error"})}})}})}}})}$("td.sitemap input[name='sitemap']").bind("click",function(){var e=$(this);var t=e.parent().find(".waiting");e.css({display:"none"});i=0;var n=setInterval(function(){i=++i%7;t.html(Array(i+1).join("."))},500);$.post("/manager/seo/sitemap/",{action:"create"},function(e){if(e=="created"){clearInterval(n);t.text("OK")}})});$("#nav_list li div span.edit").live("click",function(){var e=$(this).parent().parent().next();if(e.is(":visible")){e.slideUp("slow")}else{$(".nav_edit").slideUp("slow");e.slideToggle("slow")}});$("#nav_list li div span.remove").live("click",function(){var e=$(this).parent().parent().next().find(".edit_pk").val();var t=$(this).parent().parent().parent();$.post("/manager/nav/remove/",{pk:e},function(e){if(e["error"]){$("#notificator").notification({text:e["error"],type:"error"})}else{$("#nav_list").html(e["html"]);o();$(".nav_edit .edit_url").eComboBox()}})});$("#nav_list .form-submit").live("click",function(){$table=$(this).parent().parent().parent();var e=$table.find(".edit_pk").val();var t=$table.find(".edit_menu").val();var n=$table.find(".edit_title").val();var r=$table.find(".edit_url").val();var i=$table.find(".edit_order").val();$.post("/manager/nav/"+e+"/",{menu_name:t,title:n,url:r,order_num:i},function(e){if(e["error"]){$("#notificator").notification({text:e["error"],type:"error"})}else{$("#nav_list").html(e["html"]);o();$(".nav_edit .edit_url").eComboBox()}})});$("#nav_new .new_url").eComboBox();$(".nav_edit .edit_url").eComboBox();$("#nav_new .form-submit").bind("click",function(){$table=$(this).parent().parent().parent();var e=$table.find(".new_menu").val();var t=$table.find(".new_title").val();var n=$table.find(".new_url").val();var r=$table.find(".new_order").val();$.post("/manager/nav/",{menu_name:e,title:t,url:n,order_num:r},function(e){if(e["error"]){$("#notificator").notification({text:e["error"],type:"error"})}else{$("#nav_list").html(e["html"]);o();$(".nav_edit .edit_url").eComboBox()}})});$(".page-list .page_edit").bind("click",function(){$(this).find("form").submit()});$(".page-list .page_delete").bind("click",function(){$(this).find("form").submit()});$("#page-title-form").change(function(){var e=$(this);var t=$("#page-name-form");var n=$("#status #save");t.val("");t.attr("disabled",true);n.attr("disabled",true);$.post("/manager/pages/url/",{text:e.val()},function(e){t.attr("disabled",false);t.val(e);n.attr("disabled",false)}).error(function(){t.attr("disabled",false);t.val("");n.attr("disabled",false)})});$("#layout_title").disableSelection();$("#layout_btn input").bind("click",function(){$("#layouts .columnwrapper").slideToggle("fast")});$("#layouts .column li").bind("mouseenter",function(){$(this).css("background-color","#f7f1c8");$(this).css("border","1px solid #8f4237")});$("#layouts .column li").bind("mouseleave",function(){$(this).css("background-color","#fff");$(this).css("border","1px solid #fff")});$("#layouts .layout_img").bind("click",function(){var e=$(this).parent().find(".layout_name").html();$.post("/manager/pages/layout/",{action:"load",name:e},function(e){var t=$("#editor textarea");t.wysiwyg("clear");t.wysiwyg("setContent",e["content"])})});$(".checkbox").change(function(){if($(this).is(":checked"))$(this).next("label").addClass("label-selected").html("Page is active");else $(this).next("label").removeClass("label-selected").html("Page is hidden")});$("#delete").bind("click",function(){var e=$("#pk").val();$(".delete_form").append('<input type="hidden" name="pk" value="'+e+'" />').submit()});$("#save").bind("click",function(){var e=$("#pk").val();var t=$("#page-name-form").val();var n=$("#page-title-form").val();var r=$(".editor_iframe").contents().find("body").html();var i="off";if($("#active").attr("checked"))i="on";$.post("/manager/page/save/",{pk:e,name:t,title:n,content:r,status:i},function(e){if(e["result"]=="created"){$("#pk").val(e["pk"]);$("#notificator").notification({text:"Page has beed created",type:"info"})}if(e["result"]=="updated"){$("#notificator").notification({text:"Page has beed updated",type:"info"})}if(e["result"]=="error"){$("#notificator").notification({text:"Error saving page",type:"error"})}$("html, body").animate({scrollTop:0},"slow")})});$("#preview").bind("click",function(){if($("#page_edit").is(":visible")){$("#page_edit").animate({left:"1000px"},500,function(){$(this).hide();$("#pk").after('<div class="wrapper page-canvas"></div>');$("#pk").after('<form action="/manager/page/preview/" id="preview_frame" target="preview_frame" method="post"><input type="hidden" name="content" value="" /></form>');$(".wrapper").html('<iframe name="preview_frame" width="100%" height="700" frameBorder="0"></iframe>');$("#preview_frame input").val($(".editor_iframe").contents().find("body").html());$("#preview_frame").submit();$("#preview").attr({value:"Edit"});$("#status").css({"z-index":1e3});$("#overlay").removeClass("hide")})}else{$(".wrapper").animate({left:"1000px"},500,function(){$("#overlay").addClass("hide");$("#status").css({"z-index":0});$("#page_edit").css({left:"0px"});$("#page_edit").show();$("#preview").attr({value:"Preview"});$(this).remove()})}});$(".checkbox-label").disableSelection();$(".property_list .remove").live("click",function(){var e=$(this).parent();e.slideUp("fast");e.remove()});$("#properties_form .next").bind("click",function(){var e={};$(".property_list li.sort").each(function(){$this=$(this);var t=$this.index();var n=$this.find("div:nth-child(1)").html();var r=$this.find("div:nth-child(2)").html();e[n]=[t,r]});$("#properties_form").append("<input type='hidden' name='properties' value='"+$.toJSON(e)+"' />");$("#properties_form").submit()});$("#add_property .form-submit").bind("click",function(){var e=$("#add_property .form-text").val();var t=$("#add_property .property_container option:selected").html();if(/^[\s\d\wА-Яа-я-]{1,75}$/.test(e)&&t.length){$row=$("ul.property_list").find("li:last-child");$row.before('<li class="sort block"><div></div><div></div><div class="remove">&#10006;</div></li>');$row.prev().find("div:nth-child(1)").html(e);$row.prev().find("div:nth-child(2)").html("( "+t+" )");$("#add_property .prompt").css("color","#1155CC")}else{$("#add_property .prompt").css("color","#990000")}});$(".property_list").sortable({items:"li.sort",placeholder:"ui-state-highlight",forcePlaceholderSize:true});$("li.sort").disableSelection();var e=null;var t=null;var n=null;var r=null;$("#img_upload_btn").live("click",function(){function f(){result=null;$.ajax({url:t+"progress/",data:{"X-Progress-ID":1},success:function(e,t){if(e[0]!=e[1]){result=e}if(e[0]==e[1]&&e[0]!="error"){result="complete"}if(e[0]=="error"){if(n==5)result="error";else{n+=1;result=e}}},error:function(e,t){result="error"},type:"GET",dataType:"json",async:false});return result}var e=$(".ui-dialog #ci_image_upload form");var t=e.attr("action");var n=0;e.attr("action",t+"?X-Progress-ID=1");e.submit();var r=0;var i=$(".ui-dialog .bar .progress");var s=$(".ui-dialog .bar .percent");var o=i.parent().width();var u="0%";var a=0;i.parent().css({border:"1px solid #ccc"});s.css({display:"block"});s.text("0%");r=setInterval(function(){result=f();if(result=="error"){clearInterval(r);s.text("upload error");i.css({"background-color":"#990000"});return}if(result=="complete"){clearInterval(r);s.text("100%");i.width(o);return}if(result[0]>0)a=Math.round(result[0]/result[1]*100)/100;else a=0;u=Math.round(a*100)+"%";s.text(u);i.width(a*o)},1e3)});$(".ui-dialog #ci_image_upload form").ajaxForm({complete:function(e){if(e.responseText=="error"){$(".top-text .upload_msg").css({display:"none"});$(".top-text .err_msg").css({display:"block"})}else s(e.responseText)},delegation:true,async:true});$(".images_add .add_image .form-submit").bind("click",function(){image_dialog=$("#image_result").clone().dialog({title:"Add image",closeText:"x",modal:true,width:640,height:440,autoOpen:false,create:function(e,t){$(e.target).parent().css("position","fixed");$(".ui-dialog .top-text .upload_msg").css({display:"block"});$(".ui-dialog .top-text .err_msg").css({display:"none"})},close:function(e,t){$(this).dialog("destroy").remove()}});image_dialog.dialog("open");e=$(".ui-dialog .bar");t=$(".ui-dialog .percent");n=$(".ui-dialog-content")});var s=function(e){if($("#image_preview").length){if($("#image_preview img").attr("alt")!="No image"){$.post("/manager/resize/",{name:e,size:"mini"},function(e){if(e!="error"){if($(".extra_images").length==0){$("#image_preview").after('<table class="extra_images"><tr><td><div class="frame"></div></td><td><div class="frame"></div></td><td><div class="frame"></div></td></tr></table>');$(".extra_images td:first-child div.frame").html('<div class="crop">'+e+'</div><span class="remove">&#10006;</span>');image_dialog.dialog("close")}else{if($(".extra_images tr:last-child td:nth-child(2) div.frame").find("img").length==0){$(".extra_images tr:last-child td:nth-child(2) div.frame").html('<div class="crop">'+e+'</div><span class="remove">&#10006;</span>');image_dialog.dialog("close");return false}if($(".extra_images tr:last-child td:last-child div.frame").find("img").length!=0)$(".extra_images").append("<tr>"+'<td><div class="frame"><div class="crop">'+e+'</div><span class="remove">&#10006;</span></div></td>'+'<td><div class="frame"></div></td>'+'<td><div class="frame"></div></td>'+"</tr>");else $(".extra_images tr:last-child td:last-child div.frame").html('<div class="crop">'+e+'</div><span class="remove">&#10006;</span>');image_dialog.dialog("close")}}})}else{$.post("/manager/resize/",{name:e,size:"small"},function(e){if(e!="error"){$("#image_preview").html(e);image_dialog.dialog("close")}})}}else{}};$(".ui-dialog #ci_img_browse_btn").live("click",function(){$.post("/manager/browse/",{},function(e){n=$(".ui-dialog-content");n.html(e)})});$(".ui-dialog .thumb_browse td div.crop").live("dblclick",function(){var e=$(this).find("img").attr("src");if(e)s($(this).find("img").attr("src"))});$("#image_result .thumb_browse td div.frame span.remove").live("click",function(){var e=$(this).parent().find("img").attr("src");if(e){$.post("/manager/uploaded/remove/",{src:e},function(e){if(e!="error"){$(".ui-dialog #image_result").html(e)}})}});$(".browse_nav .upload input").live("click",function(){n.html($("#image_result").html())});$(".browse_nav .nav .prev").live("click",function(){var e=$(".browse_nav").prev("input[name=page]").val();e=parseInt(e)-1;$.post("/manager/browse/",{page:e},function(e){if(e!="error"){$(".ui-dialog-content").html(e)}})});$(".browse_nav .nav .next").live("click",function(){var e=$(".browse_nav").prev("input[name=page]").val();e=parseInt(e)+1;$.post("/manager/browse/",{page:e},function(e){if(e!="error"){$(".ui-dialog-content").html(e)}})});$("table.extra_images td span.remove").live("click",function(){$(this).parent().html("");if(!$(".extra_images").find(".crop img").length)$(".extra_images").remove()});$(".data_add form").submit(function(){var e={};e["main"]=$("#image_preview img").attr("src");e["extra"]=[];$(".extra_images img").each(function(){e["extra"].push($(this).attr("src"))});$(this).find("input[name=images]").val($.toJSON(e))});o();$(".category_table table tr, .items_table table tr").live("mouseover",function(){$(this).addClass("selected-row")});$(".category_table table tr, .items_table table tr").live("mouseout",function(){$(this).removeClass("selected-row")});$(".category_table .list .catalog-nav input[name=catalog_prev]").live("click",function(){var e=$(this);var t=$(".catalog-nav input[name=page]").val();t=parseInt(t)-1;if(t<1)t=1;var n=$(".catalog-nav input[name=category]").val();n=parseInt(n);if(n<0)n=0;$(".catalog-nav input[name=page]").val(t);$.post("/manager/catalog/",{category:n,page:t},function(e){$(".category_table").html(e)})});$(".category_table .list .catalog-nav input[name=go]").live("click",function(){var e=$(".catalog-nav input[name=catalog_page]").val();if(e<1)e=1;var t=$(".catalog-nav input[name=category]").val();t=parseInt(t);if(t<0)t=0;$(".catalog-nav input[name=page]").val(e);$.post("/manager/catalog/",{category:t,page:e},function(e){$(".category_table").html(e)})});$(".category_table .list .catalog-nav input[name=catalog_next]").live("click",function(){var e=$(".catalog-nav input[name=page]").val();e=parseInt(e)+1;if(e<1)e=1;var t=$(".catalog-nav input[name=category]").val();t=parseInt(t);if(t<0)t=0;$(".catalog-nav input[name=page]").val(e);$.post("/manager/catalog/",{category:t,page:e},function(e){$(".category_table").html(e)})});$("#category_add").bind("click",function(){var e="create";var t=$("#category_name").val();$.post("/manager/catalog/category/",{action:e,name:t},function(e){if(e!="error"){$(".category_table").html(e)}})});$(".category_table .list ul.category_meta .delete").live("click",function(){var e="delete";var t=$(this).parents(".category_table table tbody tr");var n=t.find("td.first input[name=pk]").val();$.post("/manager/catalog/category/",{action:e,pk:n},function(e){if(e!="error"){if(e["number"]==0){t.fadeOut(700)}else{console.log("not empty!")}}})});$(".category_table .list ul.category_meta .clear").live("click",function(){var e="clear";var t=$(this).parents(".category_table table tbody tr");var n=t.find("td.first input[name=pk]").val();$.post("/manager/catalog/category/",{action:e,pk:n},function(e){if(e!="error"){if(e["number"]!=0){console.log("empty!")}else{console.log("already empty!")}}})});$(".category_table .list ul.category_meta .rename").live("click",function(){var e="rename";var t=$(this).parents(".category_table table tbody tr");var n=t.find("td.first input[name=pk]").val();var r=t.find("td.first .category_name").html();t.find("td.first .category_name").html('<input type="text" class="form-text cat_name_edit" id="category_name_form" value="'+r+'" /><input type="button" class="form-submit cat_name_edit" id="cat_edit_btn" value="Save" /></span>');$("#category_name_form").focus();$("body").bind("click",function(e){if(!$(e.target).hasClass("cat_name_edit")){t.find("td.first .category_name").html(r);$("body").unbind("click")}});$("#cat_edit_btn").bind("click",function(){var i=$("#category_name_form").val();if(i.length){$.post("/manager/catalog/category/",{action:e,pk:n,name:i},function(e){if(e!="error")t.find("td.first .category_name").html(e["name"]);else t.find("td.first .category_name").html(r);$("body").unbind("click")})}})});$(".category_table .list ul.category_meta .view").live("click",function(){var e=$(this).parents(".category_table table tbody tr");var t=e.find("td.first input[name=pk]").val();$.post("/manager/catalog/category/",{action:"browse",pk:t,page:2},function(e){if(e!="error"){$(".category_table .list").animate({left:"1000px"},500,function(){var n=$(this);$(this).hide();$(this).appendTo("#category_list");$(this).removeClass("list").addClass("hidden-list");$(".category_table").append(e);$(".category_create table").fadeOut("fast",function(){$(".category_create").append('<table class="back"><tr><td><div>Add new catalog item:</div><a href="/manager/catalog/add/'+t+'/"><input type="button" class="form-submit" value="Add" /></a></td><td><span>Back to categories:</span><input type="button" class="form-submit" id="back" value="Back" /></td></tr></table>')})})}})});$(".category_create #back").live("click",function(){$(".category_table .list").animate({left:"1000px"},500,function(){var e=$("#category_list .hidden-list");e.appendTo(".category_table");e.css({left:"0px"});e.removeClass("hidden-list").addClass("list");e.fadeIn("fast");$(this).remove();$(".category_create table.back").fadeOut("fast",function(){$(this).remove();$(".category_create table").fadeIn("fast")})})});$(".category_table .list ul.category_meta .add").live("click",function(){var e=$(this).parents(".category_table table tbody tr");var t=e.find("td.first input[name=pk]").val();window.location.href="/manager/catalog/add/"+t+"/"});$(".category_table .list ul.item_meta .edit").live("click",function(){var e=$(this).parents(".category_table table tbody tr");var t=e.find("td.first div").html();window.location.href="/manager/catalog/edit/?id="+t});$(".category_table .list ul.item_meta .activate").live("click",function(){$this=$(this);var e=$(this).parents(".category_table table tbody tr");var t=e.find("td.first div").html();$.post("/manager/catalog/activate/",{id:t},function(t){if(t=="hide"){e.addClass("h");$this.html("Show")}else if(t=="active"){e.removeClass("h");$this.html("Hide")}})});$(".category_table .list ul.item_meta .delete").live("click",function(){var e=$(this).parents(".category_table table tbody tr");var t=e.find("td.first div").html();$.post("/manager/catalog/delete/",{id:t},function(t){if(t!="error")e.fadeOut(700)})});$(".category_table table tr").live("mouseenter",function(){$("td",this).animate({backgroundColor:"#ccc"},100)});$(".category_table table tr").live("mouseleave",function(){if($(this).hasClass("even"))$("td",this).animate({backgroundColor:"#f5f5f5"},100);else $("td",this).animate({backgroundColor:"#fff"},100)});$("ul.category_meta li, ul.item_meta li").live("mouseenter",function(){$(this).animate({backgroundColor:"#808080",color:"#f5f5f5"},50)});$("ul.category_meta li, ul.item_meta li").live("mouseleave",function(){$(this).animate({backgroundColor:"#f5f5f5",color:"#333"},50)});$.fn.autoResize=function(e){var t=$.extend({onResize:function(){},animate:true,animateDuration:150,animateCallback:function(){},extraSpace:10,limit:1e3},e);this.filter("textarea").each(function(){var e=$(this).css({resize:"none","overflow-y":"hidden"}),n=e.height(),r=function(){var t=["height","width","lineHeight","textDecoration","letterSpacing"],n={};$.each(t,function(t,r){n[r]=e.css(r)});return e.clone().removeAttr("id").removeAttr("name").css({position:"absolute",top:0,left:-9999}).css(n).attr("tabIndex","-1").insertBefore(e)}(),i=null,s=function(){r.height(0).val($(this).val()).scrollTop(1e4);var s=Math.max(r.scrollTop(),n)+t.extraSpace,o=$(this).add(r);if(i===s){return}i=s;if(s>=t.limit){$(this).css("overflow-y","");return}t.onResize.call(this);t.animate&&e.css("display")==="block"?o.stop().animate({height:s},t.animateDuration,t.animateCallback):o.height(s)};e.unbind(".dynSiz").bind("keyup.dynSiz",s).bind("keydown.dynSiz",s).bind("change.dynSiz",s)});return this};$(".data_add textarea").autoResize();if($(".settings #settings_logo img").attr("src")==""){$(".settings #settings_logo .remove").hide("fast")}$(".settings #settings_logo .remove").click(function(){var e=$(this);$.post("/manager/settings/logo/clear/",{action:"delete"},function(t){if(t=="success"){$("#settings_logo img").attr("src","");e.hide("fast")}})});$(".settings input[type=file]").change(function(){$(".ui-dialog #ci_image_upload form").ajaxForm({beforeSend:function(){var e="0%";bar.width(e);percent.html(e)},uploadProgress:function(e,t,n,r){var i=r+"%";bar.width(i);percent.html(i)},complete:function(e){if(e.responseText=="error"){$(".top-text .upload_msg").css({display:"none"});$(".top-text .err_msg").css({display:"block"})}else s(e.responseText)},delegation:true,async:true})});$(".settings .connect #radio_yes").bind("click",function(){$(".connect_email").slideDown("fast")});$(".settings .connect #radio_no").bind("click",function(){$(".connect_email").slideUp("fast")});$.fn.notification=function(e){var t={text:"",type:"info",onOk:false,onCancel:true};if(e)$.extend(t,e);return this.each(function(){var e=$(this);if(e.is(":hidden")){e.addClass(t["type"]);e.html('<div class="message">'+t["text"]+"</div>");e.append('<div class="buttons">');if(typeof t["onOk"]=="function"){e.append('<input id="ok-button" class="notify-button" type="button" value="Save" />')}if(t["onCancel"]==true){e.append('<input id="cancel-button" class="notify-button" type="button" value="Close" />')}e.append("</div>");e.slideDown("fast")}if(typeof t["onOk"]=="function"){$ok=e.find("#ok-button");$ok.unbind("click");$ok.bind("click",function(){t["onOk"]();$ok.unbind("click");e.slideUp("fast")})}$cancel=e.find("#cancel-button");$cancel.unbind("click");$cancel.bind("click",function(){e.slideUp("fast")})})}})