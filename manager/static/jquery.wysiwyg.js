/**
 * WYSIWYG - jQuery plugin 0.97
 * (0.97.2 - From infinity)
 *
 * Copyright (c) 2008-2009 Juan M Martinez, 2010-2011 Akzhan Abdulin and all contributors
 * https://github.com/akzhan/jwysiwyg
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */

(function(e){"use strict";function r(){var n=this;var r='<div id="image_result"><table id="image_insert"><tr><td>'+'<div id="image_upload"><form action="/admin/upload/" method="post" enctype="multipart/form-data">'+'<div class="top-text"><div>Insert image from your computer</div>'+'<input type="file" id="file_upload" name="image"></div><div id="upload_btn_wrap">'+'<input type="submit" class="form-submit" id="img_upload_btn" value="Upload"></div><div id="upload_result">'+'<div class="bar"><div class="percent"></div></div></div></form></div></td><td>'+'<div class="top-text">Choose an image from already uploaded</div><div id="image_browse">'+'<div id="browse_btn_wrap"><input type="button" class="form-submit" id="ci_img_browse_btn" value="Browse">'+"</div></div></td></tr></table></div>";e("#editor textarea").append(r);var i=e("#image_result").dialog({title:"Insert image",closeText:"x",modal:true,width:640,height:440,autoOpen:false,create:function(t,n){e(t.target).parent().css("position","fixed")},close:function(t,n){e(this).html(e(r).children("#image_insert"))}});var s=e(".bar");var o=e(".percent");var u=e(".ui-dialog-content#image_result");var a=e(".top-text div");e("#image_insert_btn").live("click",function(){n.insertHtml('<img src="'+e("#uploaded img").attr("src")+'" alt="" title="" align="'+e("#img_float").val()+'">');i.dialog("close")});e("#img_browse_btn").live("click",function(){e.get("/admin/browse/",{},function(e){u.html(e)})});e(".thumb_browse td div.crop").live("dblclick",function(){e.post("/admin/choice/",{image:e(this).find("img").attr("src")},function(e){if(e!="error"){u.html(e);t.log(u)}})});e("#img_mini").live("click",function(){if(e(this).is(":checked")){name=e("#uploaded img").attr("src");e.post("/admin/resize/",{name:name,size:"mini"},function(t){if(t!="error"){e("#uploaded div").html(t)}})}});e("#img_small").live("click",function(){if(e(this).is(":checked")){name=e("#uploaded img").attr("src");e.post("/admin/resize/",{name:name,size:"small"},function(t){if(t!="error")e("#uploaded div").html(t)})}});e("#img_medium").live("click",function(){if(e(this).is(":checked")){name=e("#uploaded img").attr("src");e.post("/admin/resize/",{name:name,size:"medium"},function(t){if(t!="error")e("#uploaded div").html(t)})}});e("#img_big").live("click",function(){if(e(this).is(":checked")){name=e("#uploaded img").attr("src");e.post("/admin/resize/",{name:name,size:"big"},function(t){if(t!="error")e("#uploaded div").html(t)})}});e(".image_float li").live("click",function(){e(".image_float li").removeClass("float-selected");e(this).addClass("float-selected");if(e(this).hasClass("img_float_none"))e("#img_float").val("none");if(e(this).hasClass("img_float_left"))e("#img_float").val("left");if(e(this).hasClass("img_float_right"))e("#img_float").val("right")});this.controls={heading:{groupIndex:0,visible:true,tags:["big"],tooltip:"Text styles",exec:function(){this.heading()}},style1:{visible:false,groupIndex:0,tooltip:"Text style 1",exec:function(){var e=this.getInternalRange();if(e.toString().length){var t=document.createElement("span");t.className="style1";var n=e.extractContents();t.appendChild(n);e.insertNode(t)}}},style2:{visible:false,groupIndex:0,tooltip:"Text style 2",exec:function(){var e=this.getInternalRange();if(e.toString().length){var t=document.createElement("span");t.className="style2";var n=e.extractContents();t.appendChild(n);e.insertNode(t)}}},style3:{visible:false,groupIndex:0,tooltip:"Text style 3",exec:function(){var e=this.getInternalRange();if(e.toString().length){var t=document.createElement("span");t.className="style3";var n=e.extractContents();t.appendChild(n);e.insertNode(t)}}},style4:{visible:false,groupIndex:0,tooltip:"Text style 4",exec:function(){var e=this.getInternalRange();if(e.toString().length){var t=document.createElement("span");t.className="style4";var n=e.extractContents();t.appendChild(n);e.insertNode(t)}}},style5:{visible:false,groupIndex:0,tooltip:"Text style 5",exec:function(){var e=this.getInternalRange();if(e.toString().length){var t=document.createElement("span");t.className="style5";var n=e.extractContents();t.appendChild(n);e.insertNode(t)}}},removeFormat:{groupIndex:0,visible:false,exec:function(){this.removeFormat()},tooltip:"Remove formatting"},bold:{groupIndex:0,visible:true,tags:["b","strong"],css:{fontWeight:"bold"},tooltip:"Bold",hotkey:{ctrl:1,key:66}},italic:{groupIndex:0,visible:true,tags:["i","em"],css:{fontStyle:"italic"},tooltip:"Italic",hotkey:{ctrl:1,key:73}},undo:{groupIndex:1,visible:true,tooltip:"Undo"},redo:{groupIndex:1,visible:true,tooltip:"Redo"},justifyFull:{groupIndex:2,visible:true,css:{textAlign:"justify"},tooltip:"Justify Full"},justifyLeft:{visible:true,groupIndex:2,css:{textAlign:"left"},tooltip:"Justify Left"},justifyCenter:{groupIndex:2,visible:true,tags:["center"],css:{textAlign:"center"},tooltip:"Justify Center"},justifyRight:{groupIndex:2,visible:true,css:{textAlign:"right"},tooltip:"Justify Right"},insertImage:{groupIndex:3,visible:true,exec:function(){var t=this;i.dialog("open");e("img_upload_btn").live("click",function(){s.show()});e("#image_upload form").ajaxForm({beforeSend:function(){var e="0%";s.width(e);o.html(e)},uploadProgress:function(e,t,n,r){var i=r+"%";s.width(i);o.html(i)},complete:function(e){if(e.responseText=="error")a.html('<span class="err_msg">Choose image</span>');else u.html(e.responseText)}})},tags:["img"],tooltip:"Insert image"},createLink:{groupIndex:3,visible:true,exec:function(){var n=this;if(e.wysiwyg.controls&&e.wysiwyg.controls.link){e.wysiwyg.controls.link.init(this)}else if(e.wysiwyg.autoload){e.wysiwyg.autoload.control("wysiwyg.link.js",function(){n.controls.createLink.exec.apply(n)})}else{t.error("$.wysiwyg.controls.link not defined. You need to include wysiwyg.link.js file")}},tags:["a"],tooltip:"Create link"},indent:{groupIndex:4,visible:true,tooltip:"Indent"},outdent:{groupIndex:4,visible:true,tooltip:"Outdent"},insertUnorderedList:{groupIndex:5,visible:true,tags:["ul"],tooltip:"Insert Unordered List"},insertOrderedList:{groupIndex:5,visible:true,tags:["ol"],tooltip:"Insert Ordered List"}};this.defaults={html:'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" style="margin:0"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link rel="stylesheet" type="text/css" href="/admin/static/commons.css" media="all" /></head><body style="margin:0;">INITIAL_CONTENT</body></html>',debug:false,controls:{},css:{},events:{},autoGrow:true,autoSave:true,brIE:true,formHeight:270,formWidth:440,iFrameClass:null,initialContent:"",maxHeight:1e4,maxLength:0,messages:{nonSelection:"Select the text you wish to link"},toolbarHtml:'<ul role="menu" class="toolbar"></ul>',removeHeadings:false,replaceDivWithP:false,resizeOptions:false,rmUnusedControls:false,rmUnwantedBr:true,tableFiller:"Lorem ipsum",initialMinHeight:null,controlImage:{forceRelativeUrls:false},controlLink:{forceRelativeUrls:false},plugins:{autoload:false,i18n:false,rmFormat:{rmMsWordMarkup:false}},dialog:"jqueryui"};this.availableControlProperties=["arguments","callback","className","command","css","custom","exec","groupIndex","hotkey","icon","tags","tooltip","visible"];this.editor=null;this.editorDoc=null;this.element=null;this.options={};this.original=null;this.savedRange=null;this.timers=[];this.validKeyCodes=[8,9,13,16,17,18,19,20,27,33,34,35,36,37,38,39,40,45,46];this.isDestroyed=false;this.dom={ie:{parent:null},w3c:{parent:null}};this.dom.parent=this;this.dom.ie.parent=this.dom;this.dom.w3c.parent=this.dom;this.ui={};this.ui.self=this;this.ui.toolbar=null;this.ui.initialHeight=null;this.dom.getAncestor=function(e,t){t=t.toLowerCase();while(e&&typeof e.tagName!="undefined"&&"body"!==e.tagName.toLowerCase()){if(t===e.tagName.toLowerCase()){return e}e=e.parentNode}if(!e.tagName&&(e.previousSibling||e.nextSibling)){if(e.previousSibling){if(e.previousSibling.tagName.toLowerCase()==t){return e.previousSibling}}if(e.nextSibling){if(e.nextSibling.tagName.toLowerCase()==t){return e.nextSibling}}}return null};this.dom.getElement=function(e){var t=this;e=e.toLowerCase();if(window.getSelection){return t.w3c.getElement(e)}else{return t.ie.getElement(e)}};this.dom.ie.getElement=function(e){var t=this.parent,n=t.parent.getInternalSelection(),r=n.createRange(),i;if("Control"===n.type){if(1===r.length){i=r.item(0)}else{return null}}else{i=r.parentElement()}return t.getAncestor(i,e)};this.dom.w3c.getElement=function(e){var t=this.parent,n=t.parent.getInternalRange(),r;if(!n){return null}r=n.commonAncestorContainer;if(3===r.nodeType){r=r.parentNode}if(r===n.startContainer){r=r.childNodes[n.startOffset]}if(!r.tagName&&(r.previousSibling||r.nextSibling)){if(r.previousSibling){if(r.previousSibling.tagName.toLowerCase()==e){return r.previousSibling}}if(r.nextSibling){if(r.nextSibling.tagName.toLowerCase()==e){return r.nextSibling}}}return t.getAncestor(r,e)};this.ui.addHoverClass=function(){e(this).addClass("wysiwyg-button-hover")};this.ui.appendControls=function(){var t=this,n=this.self,r=n.parseControls(),i=true,s=[],o={},u,a,f=function(e,n){if(n.groupIndex&&a!==n.groupIndex){a=n.groupIndex;i=false}if(!n.visible){return}if(!i){t.appendItemSeparator();i=true}if(n.custom){t.appendItemCustom(e,n)}else{t.appendItem(e,n)}};e.each(r,function(e,t){var n="empty";if(undefined!==t.groupIndex){if(""===t.groupIndex){n="empty"}else{n=t.groupIndex}}if(undefined===o[n]){s.push(n);o[n]={}}o[n][e]=t});s.sort(function(e,t){if("number"===typeof e&&typeof e===typeof t){return e-t}else{e=e.toString();t=t.toString();if(e>t){return 1}if(e===t){return 0}return-1}});if(0<s.length){a=s[0]}for(u=0;u<s.length;u+=1){e.each(o[s[u]],f)}};this.ui.appendItem=function(t,n){var r=this.self,i=n.className||n.command||t||"empty",s=n.tooltip||n.command||t||"";return e('<li role="menuitem" unselectable="on">'+i+"</li>").addClass(i).attr("title",s).hover(this.addHoverClass,this.removeHoverClass).click(function(i){if(e(this).hasClass("disabled")){return false}r.triggerControl.apply(r,[t,n]);var s=e(i.target);for(var o in r.controls){if(s.hasClass(o)){r.ui.toolbar.find("."+o).toggleClass("active");r.editorDoc.rememberCommand=true;break}}this.blur();r.ui.returnRange();r.ui.focus();return true}).appendTo(r.ui.toolbar)};this.ui.appendItemCustom=function(t,n){var r=this.self,i=n.tooltip||n.command||t||"";if(n.callback){e(window).bind("trigger-"+t+".wysiwyg",n.callback)}return e('<li role="menuitem" unselectable="on" style="background: url(\''+n.icon+"') no-repeat;\"></li>").addClass("custom-command-"+t).addClass("wysiwyg-custom-command").addClass(t).attr("title",i).hover(this.addHoverClass,this.removeHoverClass).click(function(){if(e(this).hasClass("disabled")){return false}r.triggerControl.apply(r,[t,n]);this.blur();r.ui.returnRange();r.ui.focus();r.triggerControlCallback(t);return true}).appendTo(r.ui.toolbar)};this.ui.appendItemSeparator=function(){var t=this.self;return e('<li role="separator" class="separator"></li>').appendTo(t.ui.toolbar)};this.autoSaveFunction=function(){this.saveContent()};this.ui.checkTargets=function(t){var n=this.self;e.each(n.options.controls,function(r,i){var s=i.className||i.command||r||"empty",o,u,a,f,l=function(e,t){var r;if("function"===typeof t){r=t;if(r(f.css(e).toString().toLowerCase(),n)){n.ui.toolbar.find("."+s).addClass("active")}}else{if(f.css(e).toString().toLowerCase()===t){n.ui.toolbar.find("."+s).addClass("active")}}};if("fullscreen"!==s){n.ui.toolbar.find("."+s).removeClass("active")}if(i.tags||i.options&&i.options.tags){o=i.tags||i.options&&i.options.tags;u=t;while(u){if(u.nodeType!==1){break}if(e.inArray(u.tagName.toLowerCase(),o)!==-1){n.ui.toolbar.find("."+s).addClass("active")}u=u.parentNode}}if(i.css||i.options&&i.options.css){a=i.css||i.options&&i.options.css;f=e(t);while(f){if(f[0].nodeType!==1){break}e.each(a,l);f=f.parent()}}})};this.ui.designMode=function(){var e=3,t=this.self,n;n=function(e){if("on"===t.editorDoc.designMode){if(t.timers.designMode){window.clearTimeout(t.timers.designMode)}if(t.innerDocument()!==t.editorDoc){t.ui.initFrame()}return}try{t.editorDoc.designMode="on"}catch(r){}e-=1;if(e>0){t.timers.designMode=window.setTimeout(function(){n(e)},100)}};n(e)};this.destroy=function(){this.isDestroyed=true;var t,n=this.element.closest("form");for(t=0;t<this.timers.length;t+=1){window.clearTimeout(this.timers[t])}n.unbind(".wysiwyg");this.element.remove();e.removeData(this.original,"wysiwyg");e(this.original).show();return this};this.getRangeText=function(){var e=this.getInternalRange();if(e.toString){e=e.toString()}else if(e.text){e=e.text}return e};this.execute=function(e,t){if(typeof t==="undefined"){t=null}this.editorDoc.execCommand(e,false,t)};this.extendOptions=function(t){var n={};if("object"===typeof t.controls){n=t.controls;delete t.controls}t=e.extend(true,{},this.defaults,t);t.controls=e.extend(true,{},n,this.controls,n);if(t.rmUnusedControls){e.each(t.controls,function(e){if(!n[e]){delete t.controls[e]}})}return t};this.ui.focus=function(){var e=this.self;e.editor.get(0).contentWindow.focus();return e};this.ui.returnRange=function(){var e=this.self,n;if(e.savedRange!==null){if(window.getSelection){n=window.getSelection();if(n.rangeCount>0){n.removeAllRanges()}try{n.addRange(e.savedRange)}catch(r){t.error(r)}}else if(window.document.createRange){window.getSelection().addRange(e.savedRange)}else if(window.document.selection){e.savedRange.select()}e.savedRange=null}};e("#hpop li").live("mouseenter",function(){e(this).css("background-color","#f7f1c8");e(this).css("border","1px solid #8f4237")});e("#hpop li").live("mouseleave",function(){e(this).css("background-color","#fff");e(this).css("border","1px solid #fff")});e("#hpop li.style1").live("click",function(){n.triggerControl("style1",n.controls["style1"]);e("#hpop").removeClass("s");e("#hpop").slideUp("fast")});e("#hpop li.style2").live("click",function(){n.triggerControl("style2",n.controls["style2"]);e("#hpop").removeClass("s");e("#hpop").slideUp("fast")});e("#hpop li.style3").live("click",function(){n.triggerControl("style3",n.controls["style3"]);e("#hpop").removeClass("s");e("#hpop").slideUp("fast")});e("#hpop li.style4").live("click",function(){n.triggerControl("style4",n.controls["style4"]);e("#hpop").removeClass("s");e("#hpop").slideUp("fast")});e("#hpop li.style5").live("click",function(){n.triggerControl("style5",n.controls["style5"]);e("#hpop").removeClass("s");e("#hpop").slideUp("fast")});e("#hpop li.rmfmt").live("click",function(){n.triggerControl("removeFormat",n.controls["removeFormat"]);e("#hpop").removeClass("s");e("#hpop").slideUp("fast")});this.heading=function(t){if(e("#hpop").hasClass("s")){e("#hpop").removeClass("s");e("#hpop").slideUp("fast")}else{e("#hpop").addClass("s");e("#hpop").slideDown("fast")}e("#hpop").live("mouseleave",function(){e("#hpop").removeClass("s");e(this).slideUp("fast")})};this.getContent=function(){if(this.viewHTML){this.setContent(this.original.value)}return this.events.filter("getContent",this.editorDoc.body.innerHTML)};this.events={_events:{},bind:function(e,t){if(typeof this._events.eventName!=="object"){this._events[e]=[]}this._events[e].push(t)},trigger:function(t,n){if(typeof this._events.eventName==="object"){var r=this.editor;e.each(this._events[t],function(e,t){if(typeof t==="function"){t.apply(r,n)}})}},filter:function(t,n){if(typeof this._events[t]==="object"){var r=this.editor,i=Array.prototype.slice.call(arguments,1);e.each(this._events[t],function(e,t){if(typeof t==="function"){n=t.apply(r,i)}})}return n}};this.getElementByAttributeValue=function(t,n,r){var i,s,o=this.editorDoc.getElementsByTagName(t);for(i=0;i<o.length;i+=1){s=o[i].getAttribute(n);if(e.browser.msie){s=s.substr(s.length-r.length)}if(s===r){return o[i]}}return false};this.getNextNode=function(e,t){if(e.firstChild)return e.firstChild;while(e){if(e.nextSibling)return e.nextSibling;e=e.parentNode}};this.getNodesInRange=function(e){var t=e.startContainer;var n=e.endContainer;var r=e.commonAncestorContainer;var i=[];var s;for(s=t.parentNode;s;s=s.parentNode){i.push(s);if(s==r)break}i.reverse();for(s=t;s;s=this.getNextNode(s)){i.push(s);if(s==n)break}return i};this.getInternalRange=function(){var e=this.getInternalSelection();if(!e){return null}if(e.rangeCount&&e.rangeCount>0){return e.getRangeAt(0)}else if(e.createRange){return e.createRange()}return null};this.getInternalSelection=function(){if(this.editor.get(0).contentWindow){if(this.editor.get(0).contentWindow.getSelection){return this.editor.get(0).contentWindow.getSelection()}if(this.editor.get(0).contentWindow.selection){return this.editor.get(0).contentWindow.selection}}if(this.editorDoc.getSelection){return this.editorDoc.getSelection()}if(this.editorDoc.selection){return this.editorDoc.selection}return null};this.getRange=function(){var e=this.getSelection();if(!e){return null}if(e.rangeCount&&e.rangeCount>0){e.getRangeAt(0)}else if(e.createRange){return e.createRange()}return null};this.getSelection=function(){return window.getSelection?window.getSelection():window.document.selection};this.getSelectionHtml=function(){var e="";if(typeof window.getSelection!="undefined"){var t=window.getSelection();if(t.rangeCount){var n=document.createElement("div");for(var r=0,i=t.rangeCount;r<i;++r){n.appendChild(t.getRangeAt(r).cloneContents())}e=n.innerHTML}}else if(typeof document.selection!="undefined"){if(document.selection.type=="Text"){e=document.selection.createRange().htmlText}}return e};this.ui.grow=function(){var t=this.self,n=e(t.editorDoc.body),r=e.browser.msie?n[0].scrollHeight:n.height()+2+20,i=t.ui.initialHeight,s=Math.max(r,i);s=Math.min(s,t.options.maxHeight);t.editor.attr("scrolling",s<t.options.maxHeight?"no":"auto");n.css("overflow",s<t.options.maxHeight?"hidden":"");t.editor.get(0).height=s;return t};this.init=function(t,n){var r=this,i=e(t).closest("form"),s=t.width||t.clientWidth||0,o=t.height||t.clientHeight||0;this.options=this.extendOptions(n);this.original=t;this.ui.toolbar=e(this.options.toolbarHtml);if(e.browser.msie&&parseInt(e.browser.version,10)<8){this.options.autoGrow=false}if(s===0&&t.cols){s=t.cols*8+21}if(o===0&&t.rows){o=t.rows*16+16}this.editor=e(window.location.protocol==="https:"?'<iframe src="javascript:false;"></iframe>':"<iframe></iframe>").attr("frameBorder","0");if(this.options.iFrameClass){this.editor.addClass(this.options.iFrameClass)}else{this.editor.css({minHeight:(o-6).toString()+"px",width:s>50?(s-20).toString()+"px":""});if(e.browser.msie&&parseInt(e.browser.version,10)<7){this.editor.css("height",o.toString()+"px")}}if(t.id){var u=t.id+"-wysiwyg-iframe";if(!document.getElementById(u)){this.editor.attr("id",u)}}this.editor.attr("tabindex",e(t).attr("tabindex"));this.element=e("<div/>").addClass("wysiwyg");if(!this.options.iFrameClass){this.element.css({width:s>0?s.toString()+"px":"100%"})}e(t).hide().before(this.element);this.viewHTML=false;this.initialContent=e(t).val();this.ui.initFrame();if(this.options.resizeOptions&&e.fn.resizable){this.element.resizable(e.extend(true,{alsoResize:this.editor},this.options.resizeOptions))}if(this.options.autoSave){i.bind("submit.wysiwyg",function(){r.autoSaveFunction()})}i.bind("reset.wysiwyg",function(){r.resetFunction()})};this.ui.initFrame=function(){var n=this.self,r,i,s;n.ui.appendControls();n.element.append(n.ui.toolbar).append(e("<div><!-- --></div>").css({clear:"both"})).append('<div id="hpop"><ul><li class="style1">text style 1</li><li class="style2">text style 2</li><li class="style3">text style 3</li><li class="style4">text style 4</li><li class="style5">text style 5</li><li class="rmfmt">Remove formatting</li></ul></div>').append(n.editor);n.editorDoc=n.innerDocument();if(n.isDestroyed){return null}n.ui.designMode();n.editorDoc.open();n.editorDoc.write(n.options.html.replace(/INITIAL_CONTENT/,function(){return n.wrapInitialContent()}));n.editorDoc.close();e.wysiwyg.plugin.bind(n);e(n.editorDoc).trigger("initFrame.wysiwyg");e(n.editorDoc).bind("click.wysiwyg",function(e){n.ui.checkTargets(e.target?e.target:e.srcElement)});setInterval(function(){var e=null;try{var r=n.getInternalRange();if(r){e={range:r,parent:r.endContainer.parentNode,width:r.startOffset-r.endOffset||0}}}catch(i){t.error(i)}if(e&&e.width==0&&!n.editorDoc.rememberCommand){n.ui.checkTargets(e.parent)}},400);e(n.original).focus(function(){if(e(this).filter(":visible").length===0||e.browser.opera){return}n.ui.focus()});e(n.editorDoc).keydown(function(e){var t;if(e.keyCode===8){t=/^<([\w]+)[^>]*>(<br\/?>)?<\/\1>$/;if(t.test(n.getContent())){e.stopPropagation();return false}}n.editorDoc.rememberCommand=false;return true});if(!e.browser.msie){e(n.editorDoc).keydown(function(e){var t;var r;if(e.ctrlKey||e.metaKey){for(t in n.options.controls){r=n.options.controls[t];if(r.hotkey&&r.hotkey.ctrl){if(e.keyCode===r.hotkey.key){n.triggerControl.apply(n,[t,r]);return false}}}}return true})}else if(n.options.brIE){e(n.editorDoc).keydown(function(e){if(e.keyCode===13){var t=n.getRange();t.pasteHTML("<br/>");t.collapse(false);t.select();return false}return true})}if(n.options.plugins.rmFormat.rmMsWordMarkup){e(n.editorDoc).bind("keyup.wysiwyg",function(t){if(t.ctrlKey||t.metaKey){if(86===t.keyCode){if(e.wysiwyg.rmFormat){if("object"===typeof n.options.plugins.rmFormat.rmMsWordMarkup){e.wysiwyg.rmFormat.run(n,{rules:{msWordMarkup:n.options.plugins.rmFormat.rmMsWordMarkup}})}else{e.wysiwyg.rmFormat.run(n,{rules:{msWordMarkup:{enabled:true}}})}}}}})}if(n.options.autoSave){e(n.editorDoc).keydown(function(){n.autoSaveFunction()}).keyup(function(){n.autoSaveFunction()}).mousedown(function(){n.autoSaveFunction()}).bind(e.support.noCloneEvent?"input.wysiwyg":"paste.wysiwyg",function(){n.autoSaveFunction()})}if(n.options.autoGrow){if(n.options.initialMinHeight!==null){n.ui.initialHeight=n.options.initialMinHeight}else{n.ui.initialHeight=e(n.editorDoc).height()}e(n.editorDoc.body).css("border","1px solid white");i=function(){n.ui.grow()};e(n.editorDoc).keyup(i);e(n.editorDoc).bind("editorRefresh.wysiwyg",i);n.ui.grow()}if(n.options.css){if(String===n.options.css.constructor){if(e.browser.msie){r=n.editorDoc.createStyleSheet(n.options.css);e(r).attr({media:"all"})}else{r=e("<link/>").attr({href:n.options.css,media:"all",rel:"stylesheet",type:"text/css"});e(n.editorDoc).find("head").append(r)}}else{n.timers.initFrame_Css=window.setTimeout(function(){e(n.editorDoc.body).css(n.options.css)},0)}}if(n.initialContent.length===0){if("function"===typeof n.options.initialContent){n.setContent(n.options.initialContent())}else{n.setContent(n.options.initialContent)}}if(n.options.maxLength>0){e(n.editorDoc).keydown(function(t){if(e(n.editorDoc).text().length>=n.options.maxLength&&e.inArray(t.which,n.validKeyCodes)===-1){t.preventDefault()}})}e.each(n.options.events,function(t,r){e(n.editorDoc).bind(t+".wysiwyg",function(e){r.apply(n.editorDoc,[e,n])})});if(e.browser.msie){e(n.editorDoc).bind("beforedeactivate.wysiwyg",function(){n.savedRange=n.getInternalRange()})}else{e(n.editorDoc).bind("blur.wysiwyg",function(){n.savedRange=n.getInternalRange()})}e(n.editorDoc.body).addClass("wysiwyg");if(n.options.events&&n.options.events.save){s=n.options.events.save;e(n.editorDoc).bind("keyup.wysiwyg",s);e(n.editorDoc).bind("change.wysiwyg",s);if(e.support.noCloneEvent){e(n.editorDoc).bind("input.wysiwyg",s)}else{e(n.editorDoc).bind("paste.wysiwyg",s);e(n.editorDoc).bind("cut.wysiwyg",s)}}if(n.options.xhtml5&&n.options.unicode){var o={ne:8800,le:8804,para:182,xi:958,darr:8595,nu:957,oacute:243,Uacute:218,omega:969,prime:8242,pound:163,igrave:236,thorn:254,forall:8704,emsp:8195,lowast:8727,brvbar:166,alefsym:8501,nbsp:160,delta:948,clubs:9827,lArr:8656,Omega:937,Auml:196,cedil:184,and:8743,plusmn:177,ge:8805,raquo:187,uml:168,equiv:8801,laquo:171,rdquo:8221,Epsilon:917,divide:247,fnof:402,chi:967,Dagger:8225,iacute:237,rceil:8969,sigma:963,Oslash:216,acute:180,frac34:190,lrm:8206,upsih:978,Scaron:352,part:8706,exist:8707,nabla:8711,image:8465,prop:8733,zwj:8205,omicron:959,aacute:225,Yuml:376,Yacute:221,weierp:8472,rsquo:8217,otimes:8855,kappa:954,thetasym:977,harr:8596,Ouml:214,Iota:921,ograve:242,sdot:8901,copy:169,oplus:8853,acirc:226,sup:8835,zeta:950,Iacute:205,Oacute:211,crarr:8629,Nu:925,bdquo:8222,lsquo:8216,apos:39,Beta:914,eacute:233,egrave:232,lceil:8968,Kappa:922,piv:982,Ccedil:199,ldquo:8220,Xi:926,cent:162,uarr:8593,hellip:8230,Aacute:193,ensp:8194,sect:167,Ugrave:217,aelig:230,ordf:170,curren:164,sbquo:8218,macr:175,Phi:934,Eta:919,rho:961,Omicron:927,sup2:178,euro:8364,aring:229,Theta:920,mdash:8212,uuml:252,otilde:245,eta:951,uacute:250,rArr:8658,nsub:8836,agrave:224,notin:8713,ndash:8211,Psi:936,Ocirc:212,sube:8838,szlig:223,micro:181,not:172,sup1:185,middot:183,iota:953,ecirc:234,lsaquo:8249,thinsp:8201,sum:8721,ntilde:241,scaron:353,cap:8745,atilde:227,lang:10216,__replacement:65533,isin:8712,gamma:947,Euml:203,ang:8736,upsilon:965,Ntilde:209,hearts:9829,Alpha:913,Tau:932,spades:9824,dagger:8224,THORN:222,"int":8747,lambda:955,Eacute:201,Uuml:220,infin:8734,rlm:8207,Aring:197,ugrave:249,Egrave:200,Acirc:194,rsaquo:8250,ETH:208,oslash:248,alpha:945,Ograve:210,Prime:8243,mu:956,ni:8715,real:8476,bull:8226,beta:946,icirc:238,eth:240,prod:8719,larr:8592,ordm:186,perp:8869,Gamma:915,reg:174,ucirc:251,Pi:928,psi:968,tilde:732,asymp:8776,zwnj:8204,Agrave:192,deg:176,AElig:198,times:215,Delta:916,sim:8764,Otilde:213,Mu:924,uArr:8657,circ:710,theta:952,Rho:929,sup3:179,diams:9830,tau:964,Chi:935,frac14:188,oelig:339,shy:173,or:8744,dArr:8659,phi:966,iuml:239,Lambda:923,rfloor:8971,iexcl:161,cong:8773,ccedil:231,Icirc:206,frac12:189,loz:9674,rarr:8594,cup:8746,radic:8730,frasl:8260,euml:235,OElig:338,hArr:8660,Atilde:195,Upsilon:933,there4:8756,ouml:246,oline:8254,Ecirc:202,yacute:253,auml:228,permil:8240,sigmaf:962,iquest:191,empty:8709,pi:960,Ucirc:219,supe:8839,Igrave:204,yen:165,rang:10217,trade:8482,lfloor:8970,minus:8722,Zeta:918,sub:8834,epsilon:949,yuml:255,Sigma:931,Iuml:207,ocirc:244};n.events.bind("getContent",function(e){return e.replace(/&(?:amp;)?(?!amp|lt|gt|quot)([a-z][a-z0-9]*);/gi,function(e,t){if(!o[t]){t=t.toLowerCase();if(!o[t]){t="__replacement"}}var n=o[t];return String.fromCharCode(n)})})}e(n.original).trigger("ready.jwysiwyg",[n.editorDoc,n])};this.innerDocument=function(){var e=this.editor.get(0);if(e.nodeName.toLowerCase()==="iframe"){if(e.contentDocument){return e.contentDocument}else if(e.contentWindow){return e.contentWindow.document}if(this.isDestroyed){return null}t.error("Unexpected error in innerDocument")}return e};this.insertHtml=function(t){var n,r;if(!t||t.length===0){return this}if(e.browser.msie){this.ui.focus();this.editorDoc.execCommand("insertImage",false,"#jwysiwyg#");n=this.getElementByAttributeValue("img","src","#jwysiwyg#");if(n){e(n).replaceWith(t)}}else{if(e.browser.mozilla){if(1===e(t).length){r=this.getInternalRange();r.deleteContents();r.insertNode(e(t).get(0))}else{this.editorDoc.execCommand("insertHTML",false,t)}}else{if(!this.editorDoc.execCommand("insertHTML",false,t)){this.editor.focus();this.editorDoc.execCommand("insertHTML",false,t)}}}this.saveContent();return this};this.parseControls=function(){var t=this;e.each(this.options.controls,function(n,r){e.each(r,function(r){if(-1===e.inArray(r,t.availableControlProperties)){throw n+'["'+r+'"]: property "'+r+'" not exists in Wysiwyg.availableControlProperties'}})});if(this.options.parseControls){return this.options.parseControls.call(this)}return this.options.controls};this.removeFormat=function(){if(e.browser.msie){this.ui.focus()}if(this.options.removeHeadings){this.editorDoc.execCommand("formatBlock",false,"<p>")}this.editorDoc.execCommand("removeFormat",false,null);this.editorDoc.execCommand("unlink",false,null);if(e.wysiwyg.rmFormat&&e.wysiwyg.rmFormat.enabled){if("object"===typeof this.options.plugins.rmFormat.rmMsWordMarkup){e.wysiwyg.rmFormat.run(this,{rules:{msWordMarkup:this.options.plugins.rmFormat.rmMsWordMarkup}})}else{e.wysiwyg.rmFormat.run(this,{rules:{msWordMarkup:{enabled:true}}})}}return this};this.ui.removeHoverClass=function(){e(this).removeClass("wysiwyg-button-hover")};this.resetFunction=function(){this.setContent(this.initialContent)};this.saveContent=function(){if(this.viewHTML){return}if(this.original){var t,n;t=this.getContent();if(this.options.rmUnwantedBr){t=t.replace(/<br\/?>$/,"")}if(this.options.replaceDivWithP){n=e("<div/>").addClass("temp").append(t);n.children("div").each(function(){var t=e(this),n=t.find("p"),r;if(0===n.length){n=e("<p></p>");if(this.attributes.length>0){for(r=0;r<this.attributes.length;r+=1){n.attr(this.attributes[r].name,t.attr(this.attributes[r].name))}}n.append(t.html());t.replaceWith(n)}});t=n.html()}e(this.original).val(t).change();if(this.options.events&&this.options.events.save){this.options.events.save.call(this)}}return this};this.setContent=function(e){this.editorDoc.body.innerHTML=e;this.saveContent();return this};this.triggerControl=function(e,n){var r=n.command||e,i=n["arguments"]||[];if(n.exec){n.exec.apply(this)}else{this.ui.focus();this.ui.withoutCss();try{this.editorDoc.execCommand(r,false,i)}catch(s){t.error(s)}}if(this.options.autoSave){this.autoSaveFunction()}};this.triggerControlCallback=function(t){e(window).trigger("trigger-"+t+".wysiwyg",[this])};this.ui.withoutCss=function(){var t=this.self;if(e.browser.mozilla){try{t.editorDoc.execCommand("styleWithCSS",false,false)}catch(n){try{t.editorDoc.execCommand("useCSS",false,true)}catch(r){}}}return t};this.wrapInitialContent=function(){var e=this.initialContent,t=e.match(/<\/?p>/gi);if(!t){return"<p>"+e+"</p>"}else{}return e}}var t=window.console?window.console:{log:e.noop,error:function(t){e.error(t)}};var n="prop"in e.fn&&"removeProp"in e.fn;e.wysiwyg={messages:{noObject:"Something goes wrong, check object"},addControl:function(t,n,r){return t.each(function(){var t=e(this).data("wysiwyg"),i={},s;if(!t){return this}i[n]=e.extend(true,{visible:true,custom:true},r);e.extend(true,t.options.controls,i);s=e(t.options.toolbarHtml);t.ui.toolbar.replaceWith(s);t.ui.toolbar=s;t.ui.appendControls()})},clear:function(t){return t.each(function(){var t=e(this).data("wysiwyg");if(!t){return this}t.setContent("")})},console:t,destroy:function(t){return t.each(function(){var t=e(this).data("wysiwyg");if(!t){return this}t.destroy()})},document:function(t){var n=t.data("wysiwyg");if(!n){return undefined}return e(n.editorDoc)},getContent:function(e){var t=e.data("wysiwyg");if(!t){return undefined}return t.getContent()},getSelection:function(e){var t=e.data("wysiwyg");if(!t){return undefined}return t.getRangeText()},init:function(t,n){return t.each(function(){var t=e.extend(true,{},n),i;if("textarea"!==this.nodeName.toLowerCase()||e(this).data("wysiwyg")){return}i=new r;i.init(this,t);e.data(this,"wysiwyg",i);e(i.editorDoc).trigger("afterInit.wysiwyg")})},insertHtml:function(t,n){return t.each(function(){var t=e(this).data("wysiwyg");if(!t){return this}t.insertHtml(n)})},plugin:{listeners:{},bind:function(t){var n=this;e.each(this.listeners,function(r,i){var s,o;for(s=0;s<i.length;s+=1){o=n.parseName(i[s]);e(t.editorDoc).bind(r+".wysiwyg",{plugin:o},function(n){e.wysiwyg[n.data.plugin.name][n.data.plugin.method].apply(e.wysiwyg[n.data.plugin.name],[t])})}})},exists:function(t){var n;if("string"!==typeof t){return false}n=this.parseName(t);if(!e.wysiwyg[n.name]||!e.wysiwyg[n.name][n.method]){return false}return true},listen:function(t,n){var r;r=this.parseName(n);if(!e.wysiwyg[r.name]||!e.wysiwyg[r.name][r.method]){return false}if(!this.listeners[t]){this.listeners[t]=[]}this.listeners[t].push(n);return true},parseName:function(e){var t;if("string"!==typeof e){return false}t=e.split(".");if(2>t.length){return false}return{name:t[0],method:t[1]}},register:function(n){if(!n.name){t.error("Plugin name missing")}e.each(e.wysiwyg,function(e){if(e===n.name){t.error("Plugin with name '"+n.name+"' was already registered")}});e.wysiwyg[n.name]=n;return true}},removeFormat:function(t){return t.each(function(){var t=e(this).data("wysiwyg");if(!t){return this}t.removeFormat()})},save:function(t){return t.each(function(){var t=e(this).data("wysiwyg");if(!t){return this}t.saveContent()})},selectAll:function(e){var t=e.data("wysiwyg"),n,r,i;if(!t){return this}n=t.editorDoc.body;if(window.getSelection){i=t.getInternalSelection();i.selectAllChildren(n)}else{r=n.createTextRange();r.moveToElementText(n);r.select()}},setContent:function(t,n){return t.each(function(){var t=e(this).data("wysiwyg");if(!t){return this}t.setContent(n)})},triggerControl:function(n,r){return n.each(function(){var n=e(this).data("wysiwyg");if(!n){return this}if(!n.controls[r]){t.error("Control '"+r+"' not exists")}n.triggerControl.apply(n,[r,n.controls[r]])})},support:{prop:n},utils:{extraSafeEntities:[["<",">","'",'"'," "],[32]],encodeEntities:function(t){var n=this,r,i=[];if(this.extraSafeEntities[1].length===0){e.each(this.extraSafeEntities[0],function(e,t){n.extraSafeEntities[1].push(t.charCodeAt(0))})}r=t.split("");e.each(r,function(t){var s=r[t].charCodeAt(0);if(e.inArray(s,n.extraSafeEntities[1])&&(s<65||s>127||s>90&&s<97)){i.push("&#"+s+";")}else{i.push(r[t])}});return i.join("")}}};e.wysiwyg.dialog=function(t,n){var r=t&&t.options&&t.options.dialog?t.options.dialog:n.theme?n.theme:"default",i=new e.wysiwyg.dialog.createDialog("jqueryui"),s=this,o=e(s);this.options={modal:true,draggable:true,title:"Title",content:"Content",width:"auto",height:"auto",zIndex:2e3,open:false,close:false};this.isOpen=false;e.extend(this.options,n);this.object=i;this.open=function(){this.isOpen=true;i.init.apply(s,[]);var e=i.show.apply(s,[]);o.trigger("afterOpen",[e])};this.show=function(){this.isOpen=true;o.trigger("beforeShow");var e=i.show.apply(s,[]);o.trigger("afterShow")};this.hide=function(){this.isOpen=false;o.trigger("beforeHide");var e=i.hide.apply(s,[]);o.trigger("afterHide",[e])};this.close=function(){this.isOpen=false;var e=i.hide.apply(s,[]);o.trigger("beforeClose",[e]);i.destroy.apply(s,[]);o.trigger("afterClose",[e]);t.ui.focus()};if(this.options.open){o.bind("afterOpen",this.options.open)}if(this.options.close){o.bind("afterClose",this.options.close)}return this};e.extend(true,e.wysiwyg.dialog,{_themes:{},_theme:"",register:function(t,n){e.wysiwyg.dialog._themes[t]=n},deregister:function(t){delete e.wysiwyg.dialog._themes[t]},createDialog:function(t){return new e.wysiwyg.dialog._themes[t]},getDimensions:function(){var t=document.body.scrollWidth,n=document.body.scrollHeight;if(e.browser.opera){n=Math.max(e(document).height(),e(window).height(),document.documentElement.clientHeight)}return[t,n]}});e(function(){if(jQuery.ui){e.wysiwyg.dialog.register("jqueryui",function(){var t=this;this._$dialog=null;this.init=function(){var n=this,r=this.options.content;if(typeof r==="object"){if(typeof r.html==="function"){r=r.html()}else if(typeof r.toString==="function"){r=r.toString()}}t._$dialog=e("<div></div>").attr("title",this.options.title).html(r);var i=this.options.height=="auto"?300:this.options.height,s=this.options.width=="auto"?450:this.options.width;t._$dialog.dialog({modal:this.options.modal,draggable:this.options.draggable,height:i,width:s});return t._$dialog};this.show=function(){t._$dialog.dialog("open");return t._$dialog};this.hide=function(){t._$dialog.dialog("close");return t._$dialog};this.destroy=function(){t._$dialog.dialog("destroy");return t._$dialog}})}});e.fn.wysiwyg=function(n){var r=arguments,i;if("undefined"!==typeof e.wysiwyg[n]){r=Array.prototype.concat.call([r[0]],[this],Array.prototype.slice.call(r,1));return e.wysiwyg[n].apply(e.wysiwyg,Array.prototype.slice.call(r,1))}else if("object"===typeof n||!n){Array.prototype.unshift.call(r,this);return e.wysiwyg.init.apply(e.wysiwyg,r)}else if(e.wysiwyg.plugin.exists(n)){i=e.wysiwyg.plugin.parseName(n);r=Array.prototype.concat.call([r[0]],[this],Array.prototype.slice.call(r,1));return e.wysiwyg[i.name][i.method].apply(e.wysiwyg[i.name],Array.prototype.slice.call(r,1))}else{t.error("Method '"+n+"' does not exist on jQuery.wysiwyg.\nTry to include some extra controls or plugins")}};e.fn.getWysiwyg=function(){return this.data("wysiwyg")};if(!e.wysiwyg.controls){e.wysiwyg.controls={}}e.wysiwyg.controls.link={init:function(t){var n=this,r,i,s,o,u,a,f,l;a='<form class="wysiwyg"><table id="link_insert">'+'<tr><td><label>Link URL: <input type="text" class="form-text" name="linkhref" value=""/></label></td></tr>'+'<tr><td><div class="button_row"><input type="submit" class="button" value="Insert link"/> '+'<input type="button" id="del_link" class="button" value="Delete link"/> <input type="reset" value="Cancel"/></div></td></tr></table></form>';o={self:t.dom.getElement("a"),href:"http://"};if(o.self){o.href=o.self.href?o.self.href:o.href}if(e.fn.dialog){r=e(a);r.find("input[name=linkhref]").val(o.href);if(e.browser.msie){try{i=r.appendTo(t.editorDoc.body)}catch(c){i=r.appendTo("body")}}else{i=r.appendTo("body")}i.dialog({modal:true,fixed:true,title:"Insert link",closeText:"x",width:350,height:150,create:function(t,n){e(t.target).parent().css("position","fixed")},open:function(n,r){e("#del_link").bind("click",function(){if(o.self)e(o.self).replaceWith(o.self.innerHTML);else{if(e.browser.msie){t.ui.returnRange()}u=t.getRangeText();l=t.dom.getElement("img");if(u&&u.length>0||l){if(e.browser.msie){t.ui.focus()}t.editorDoc.execCommand("unlink",false,null)}else if(t.options.messages.nonSelection){window.alert(t.options.messages.nonSelection)}}e(i).dialog("close")});e("input:submit",i).click(function(n){n.preventDefault();var r=e('input[name="linkhref"]',i).val(),s,a;if(t.options.controlLink.forceRelativeUrls){s=window.location.protocol+"//"+window.location.hostname;if(0===r.indexOf(s)){r=r.substr(s.length)}}if(o.self){if("string"===typeof r){if(r.length>0){e(o.self).attr("href",r)}else{e(o.self).replaceWith(o.self.innerHTML)}}}else{if(e.browser.msie){t.ui.returnRange()}u=t.getRangeText();a=t.dom.getElement("img");if(u&&u.length>0||a){if(e.browser.msie){t.ui.focus()}if("string"===typeof r){if(r.length>0){t.editorDoc.execCommand("createLink",false,r)}else{t.editorDoc.execCommand("unlink",false,null)}}o.self=t.dom.getElement("a");e(o.self).attr("href",r)}else if(t.options.messages.nonSelection){window.alert(t.options.messages.nonSelection)}}t.saveContent();e(i).dialog("close")});e("input:reset",i).click(function(t){t.preventDefault();e(i).dialog("close")})},close:function(e,t){i.dialog("destroy");i.remove()}})}e(t.editorDoc).trigger("editorRefresh.wysiwyg")}};e.wysiwyg.createLink=function(t,n){return t.each(function(){var t=e(this).data("wysiwyg"),r;if(!t){return this}if(!n||n.length===0){return this}r=t.getRangeText();if(r&&r.length>0){if(e.browser.msie){t.ui.focus()}t.editorDoc.execCommand("unlink",false,null);t.editorDoc.execCommand("createLink",false,n)}else if(t.options.messages.nonSelection){window.alert(t.options.messages.nonSelection)}return this})}})(jQuery)